using System;
using System.Collections.Generic;
using System.Linq;

namespace BossMod.Components
{
    public class RheognosisCrashExaflare : Exaflare
    {
        public RheognosisCrashExaflare() : basebase(new AOEShapeRect(10, 12))  { }

        public override void OnCastStarted(BossModule module, Actor caster, ActorCastInfo spell)
        {
            if ((AID)spell.Action.ID is AID.RheognosisCrashExaflare)
            {
                Lines.Add(new() { Next = caster.Position, Advance = 4.8f * spell.Rotation.ToDirection(), NextExplosion = spell.NPCFinishAt, TimeToMove = 0.1f, ExplosionsLeft = 5, MaxShownExplosions = 5 });
            }
        }

        public override void OnEventCast(BossModule module, Actor caster, ActorCastEvent spell)
        {
            if ((AID)spell.Action.ID is AID.RheognosisCrashExaflare)
            {
                ++NumCasts;
                int index = Lines.FindIndex(item => item.Next.AlmostEqual(caster.Position, 1));
                if (index == -1)
                {
                    module.ReportError(this, $"Failed to find entry for {caster.InstanceID:X}");
                    return;
                }

                AdvanceLine(module, Lines[index], caster.Position);
                if (Lines[index].ExplosionsLeft == 0)
                    Lines.RemoveAt(index);
            }
        }
    }
}
